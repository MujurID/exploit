<?php

if(isset($_POST['upload'])) {


    $jenis_konten = $_FILES['img']['type'];


    if(preg_match("/image/",$jenis_konten)) {

        $file_sementara = $_FILES['img']['tmp_name'];

        /**
         //periksa lagi, **cacat
         $info_gambar = @getimagesize($file_sementara);

         if(!preg_match("/image/",$info_gambar['mime'])) {
         //belum percaya periksa lagi resolusi **cacat
         if((!isset($info_gambar[0])) && (!isset($info_gambar[1]))) {
         die("Atut, ada hekel... :p");
         }
         }

         
         $file_dipermanenkan = dirname(__file__)."/".$_FILES['img']['name']; 

         
         if(move_uploaded_file($file_sementara,$file_dipermanenkan)) { 
         echo "File <strong>".$_FILES['img']['name']. "</strong> berhasil diunggah."; 
         } else { 
         echo "Gagal mengunggah!"; 
         } 
         
         **/

        $file_dipermanenkan = "/".sha1(rand(0,9999)).".jpg";
        $filename = $file_sementara;
        $percent = 1;

        // ciplak resolusi
        // pendeteksian ini masih bisa lolos dgn teknik RGB
        $size = getimagesize($filename); //diambil dari file temp, bukan $_FILE['mime']
        $width = $size[0];
        $height = $size[1];
        $mime = $size['mime'];

        //jika butuh memperkecil gambar
        $new_width = $width * $percent;
        $new_height = $height * $percent;

        // buat gambar baru


        if(preg_match('/png|jpeg|jpg|gif/',$mime)) {
            $image_p = imagecreatetruecolor($new_width,$new_height);
            if((preg_match('/jpg/',$mime)) || (preg_match('/jpeg/',$mime))) {
                $image = imagecreatefromjpeg($filename);
            }
            if(preg_match('/png/',$mime)) {
                $image = imagecreatefrompng($filename);
            }
            if(preg_match('/gif/',$mime)) {
                $im = imagecreatefromgif($filename);
            }
        }
        if(!@imagecopyresampled($image_p,$image,0,0,0,0,$new_width,$new_height,$width,$height)) {
            $image_p = imagecreate(200,100);
            $bg = imagecolorallocate($image_p,255,255,255);
            $black = imagecolorallocate($image_p,0,0,0);
            imagestring($image_p,5,2,2,'Gambar Korupsi',$black);
        }

        // Output
        imagejpeg($image_p,dirname(__file__).$file_dipermanenkan,100);
        echo '<a href="'.$file_dipermanenkan.'">'.$file_dipermanenkan.'</a>';

    } else {
        echo "Jenis file yang anda unggah bukan gambar.";
    }
}

?>
<form action="" method="post" enctype="multipart/form-data">
<input type="file" size="20" name="img" required="on" />
<input type="submit" name="upload" value="Upload" />
</form> 
